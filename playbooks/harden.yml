---
- name: Apply Linux Hardening Base
  hosts: target
  serial: 1
  any_errors_fatal: true
  become: true

  handlers:
    - name: Validate and restart sshd
      ansible.builtin.shell: sshd -t
      notify: Restart sshd service

    - name: Restart sshd service
      ansible.builtin.service:
        name: ssh
        state: restarted
      async: 1
      poll: 0
      listen: "restart sshd"
      register: ssh_restart_result
      failed_when: ssh_restart_result is failed

    - name: Verify sshd is active
      ansible.builtin.shell: systemctl is-active ssh
      listen: "restart sshd"

  roles:
    - role: base_prep
      tags: base_prep

    - role: devsec.hardening.os_hardening
      tags: os_hardening

    - role: extra_conf
      tags: extra_conf

    - role: devsec.hardening.ssh_hardening
      tags: ssh_hardening
      vars:
        # We use variables to hook into the role's behavior if needed
        # or just ensure our handlers are ready.
        sshd_custom_options:
          - "# Guard rails enabled"

    - role: fail2ban_hardening
      tags: fail2ban

    - role: sl
      tags: sl

    - role: cowrie
      tags: cowrie

    - role: auditd
      tags: auditd

    - role: integrity_scanning
      tags: integrity_scanning

    - role: system_banners
      tags: system_banners

    - role: port-knock
      tags: port-knock

  post_tasks:

    - name: Launch port knock sequence from local host
      ansible.builtin.command: "knock {{ ansible_host | default(inventory_hostname) }} {{ knock_open_sequence | join(' ') }}"
      delegate_to: localhost
      become: false
      changed_when: false
      when: knock_open_sequence is defined
      tags: port-knock

    - name: Update ansible_port to new SSH port
      ansible.builtin.set_fact:
        ansible_port: "{{ ssh_server_ports | first }}"
      when: ssh_server_ports is defined and ssh_server_ports | length > 0
      tags: always

    - name: Final SSH connection test
      ansible.builtin.wait_for_connection:
        timeout: 60
      tags: always
      ignore_errors: true

   
