---
- name: Assert Debian/Ubuntu
  ansible.builtin.assert:
    that:
      - ansible_os_family == "Debian"
    fail_msg: "Este rol está preparado para Debian/Ubuntu (/etc/default/knockd)."

- name: Install knockd
  ansible.builtin.apt:
    name: knockd
    state: present
    update_cache: true

- name: Install ufw if using ufw backend
  ansible.builtin.apt:
    name: ufw
    state: present
  when: knock_firewall_backend == "ufw"

# Detección robusta de interfaz:
# 1) si ansible_host == ansible_default_ipv4.address => usa ansible_default_ipv4.interface
# 2) si no, busca interfaz que contenga ansible_host en sus IPv4
- name: Set default knock interface when ansible_host matches default IPv4
  ansible.builtin.set_fact:
    knock_interface: "{{ ansible_default_ipv4.interface }}"
  when:
    - ansible_default_ipv4 is defined
    - ansible_default_ipv4.address is defined
    - ansible_default_ipv4.interface is defined
    - ansible_host == ansible_default_ipv4.address

- name: Detect interface for ansible_host (fallback)
  ansible.builtin.set_fact:
    knock_interface: "{{ item }}"
  loop: "{{ ansible_interfaces | default([]) }}"
  when:
    - knock_interface is not defined
    - ansible_facts[item] is defined
    - ansible_facts[item].ipv4 is defined
    - ansible_facts[item].ipv4.address is defined
    - ansible_facts[item].ipv4.address == ansible_host

- name: Fail if knock_interface not detected
  ansible.builtin.fail:
    msg: "No pude detectar la interfaz para ansible_host={{ ansible_host }}. Revisa facts (ansible -m setup) o define knock_interface manualmente."
  when: knock_interface is not defined

- name: Debug interface and ssh_port
  ansible.builtin.debug:
    msg:
      - "Detected Knock Interface: {{ knock_interface }} for IP {{ ansible_host }}"
      - "SSH port to control (ssh_port): {{ ssh_port }}"

- name: Ensure scripts directory exists
  ansible.builtin.file:
    path: "/usr/local/sbin"
    state: directory
    mode: "0755"

- name: Deploy open SSH script
  ansible.builtin.template:
    src: knock_open_ssh.sh.j2
    dest: "{{ knock_open_script_path }}"
    owner: root
    group: root
    mode: "0755"

- name: Deploy close SSH script
  ansible.builtin.template:
    src: knock_close_ssh.sh.j2
    dest: "{{ knock_close_script_path }}"
    owner: root
    group: root
    mode: "0755"

- name: Configure /etc/knockd.conf
  ansible.builtin.template:
    src: knockd.conf.j2
    dest: /etc/knockd.conf
    owner: root
    group: root
    mode: "0640"
  notify: Restart knockd

- name: Enable knockd in /etc/default/knockd
  ansible.builtin.lineinfile:
    path: /etc/default/knockd
    regexp: "^START_KNOCKD="
    line: "START_KNOCKD=1"
    create: false
  notify: Restart knockd

- name: Ensure knockd interface is set in /etc/default/knockd
  ansible.builtin.lineinfile:
    path: /etc/default/knockd
    regexp: "^KNOCKD_OPTS="
    line: 'KNOCKD_OPTS="-i {{ knock_interface }}"'
    create: false
  notify: Restart knockd

- name: Ensure knockd service is enabled and started
  ansible.builtin.service:
    name: knockd
    state: started
    enabled: true

# Info si no tocas firewall
- name: Firewall untouched on install (info)
  ansible.builtin.debug:
    msg:
      - "Instalado knockd y scripts."
      - "No se han aplicado cambios de firewall (SSH sigue como estuviera)."
      - "Para que el knocking tenga efecto, cierra SSH manualmente o activa knock_manage_firewall_on_install=true."
  when: not knock_manage_firewall_on_install

# Modo estricto: cerrar SSH al instalar (para que solo abra tras knock)
- name: Strict Port Knocking Enforcement (iptables)
  block:
    - name: Ensure SSH is closed by default (DROP new connections) - iptables
      ansible.builtin.iptables:
        chain: INPUT
        protocol: tcp
        destination_port: "{{ ssh_port }}"
        ctstate: NEW
        jump: DROP
        state: present

    - name: Ensure loopback is allowed - iptables
      ansible.builtin.iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT
        state: present

    - name: Ensure established/related is allowed - iptables
      ansible.builtin.iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT
        state: present
  when:
    - knock_manage_firewall_on_install
    - knock_firewall_backend == "iptables"

- name: Strict Port Knocking Enforcement (ufw)
  block:
    - name: Deny SSH by default - ufw
      ansible.builtin.command: "ufw deny {{ ssh_port }}/tcp"
      changed_when: false
      failed_when: false

    - name: Ensure ufw enabled
      ansible.builtin.command: "ufw --force enable"
      changed_when: false
      failed_when: false
  when:
    - knock_manage_firewall_on_install
    - knock_firewall_backend == "ufw"


